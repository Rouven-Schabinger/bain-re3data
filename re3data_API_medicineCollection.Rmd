---
title: "Can I do this with re3data API - medicine collection"
author: "Dorothea Strecker, Yi Wang"
date: "22 4 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

* * *
### For the subject medicine community, could we gather a list of repositories with detailed and updated information, where repositories provide DOI meanwhile allow our scientists to upload their own data? 


* * *
**Step 1: load Packages **

```{r load-packages, results='hide', message=FALSE, warning=FALSE}
installed.packages("htttr")
installed.packages("xml2")
library(httr)#we use httr:GET to retrieve url
library(xml2)#we load library xml2 to work with xml file

```

**Step 2: Extract re3data IDs of all repositories which satisfied the filter**

```{r }
re3data_query <- list("subjects[]" = "205 Medicine","pidSystems[]"="DOI","dataUploads[]"="open") #Query parameters need to be defined. Query parameters filter re3data metadata based on conditions you provide.

#For further filter please check the documentation API: https://www.re3data.org/api/doc
#Just in case if you don't know what is the exact the subject name you are looking for, please check following links 
#view-source:https://www.re3data.org/browse/by-subject/ 
#https://www.dfg.de/en/dfg_profile/statutory_bodies/review_boards/subject_areas/index.jsp

re3data_request <- GET("https://www.re3data.org/api/beta/repositories?", query = re3data_query) 
#The query is then passed to the re3data API using httr::GET

re3data_xml <- read_xml(re3data_request) 
URLs<- xml_text(xml_find_all(re3data_xml, xpath = "//@href"))
#transform request into XML format, here we use xpath, extract all the URLs

```

**Step 3: Make a data frame and prepare for further detailed information**

```{r }

repository_info <- data.frame(matrix(ncol = 5, nrow = 0))

colnames(repository_info) <- c("re3data_ID", "repositoryName", "repositoryUrl", "repositoryCountry","description")

```

**Step 4: Extract information based on queried urls**

```{r}
extract_info <- function(url) {
  list(
    re3data_ID = xml_text(xml_find_all(repository_metadata_XML, "//r3d:re3data.orgIdentifier")),
    
    repositoryName = xml_text(xml_find_all(repository_metadata_XML, "//r3d:repositoryName")),
    
    repositoryUrl = xml_text(xml_find_all(repository_metadata_XML, "//r3d:repositoryURL")),
  
  institutionCountry = paste(unique(xml_text(xml_find_all(repository_metadata_XML, "//r3d:institutionCountry"))),collapse="|"),#repositories:institutionCountry,1:many relationship, we here extract all unique institutionCountry values, and separate them with "|". 
  
#For further details regarding re3data metadata schema, please check https://gfzpublic.gfz-potsdam.de/pubman/faces/ViewItemOverviewPage.jsp?itemId=item_1397899
  
  description= xml_text(xml_find_all(repository_metadata_XML, "//r3d:description"))
  )
}
```

**Step 5: Gather detailed information **
```{r}
for (url in URLs) {
  repository_metadata_request <- GET(url)#query again with our collected URLs in step 2
  repository_metadata_XML <-read_xml(repository_metadata_request) 
  results_list <- extract_info(repository_metadata_XML) #call function extract_info, we defined in step 4, then put them in a list. 
  repository_info <- rbind(repository_info, results_list)#combine results of each iterations into repository_info
  
}

```

**Result**

Here is a short view of the table of repositories which allow update data and provide DOI for discipline medicine. 

```{r}
head(repository_info)

```

