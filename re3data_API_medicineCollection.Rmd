---
title: "Can I do this with re3data API - medicine collection"
author: "Dorothea Strecker, Yi Wang"
date: "22 4 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

* * *
### For the subject medicine community, could we gather a list of repositories with detailed and updated information, where repositories provide DOI meanwhile allow our scientists to upload their own data? 


* * *
**Step 1: load Packages **

```{r load-packages, results='hide', message=FALSE, warning=FALSE}
installed.packages("tidyverse")
installed.packages("htttr")
installed.packages("xml2")
installed.packages("rlist")
library(tidyverse)
library(httr)
library(xml2)
library(rlist)
```

**Step 2: Extract re3data IDs of all repositories which satisfied the filter**

```{r }
re3data_query <- list("subjects[]" = "205 Medicine","pidSystems[]"="DOI","dataUploads[]"="open") #give a filter, for further filter please check the documentation API: https://www.re3data.org/api/doc
re3data_request <- GET("https://www.re3data.org/api/beta/repositories?", query = re3data_query) 
re3data_xml <- read_xml(re3data_request) 
URLs<- xml_text(xml_find_all(re3data_xml, xpath = "//@href"))

```

**Step 3: Make a data frame and prepare for further detailed information**

```{r }

repository_info <- data.frame(matrix(ncol = 5, nrow = 0))

colnames(repository_info) <- c("re3data_ID", "repositoryName", "repositoryUrl", "repositoryCountry","description")
```

**Step 4: Extract information based on queried urls**

```{r}
extract_info <- function(url) {
  list(
    re3data_ID = xml_text(xml_find_all(repository_metadata_XML, "//r3d:re3data.orgIdentifier")),
    
    repositoryName = xml_text(xml_find_all(repository_metadata_XML, "//r3d:repositoryName")),
    
    repositoryUrl = xml_text(xml_find_all(repository_metadata_XML, "//r3d:repositoryURL")),
  
  institutionCountry = paste(unique(xml_text(xml_find_all(repository_metadata_XML, "//r3d:institutionCountry"))),collapse="|"),#repositories:institutionCountry,1:many relationship, for further details regarding re3data metadata schema, please check https://gfzpublic.gfz-potsdam.de/pubman/faces/ViewItemOverviewPage.jsp?itemId=item_1397899
  
  description= xml_text(xml_find_all(repository_metadata_XML, "//r3d:description"))
  )
}
```

**Step 5: Gather detailed information **
```{r}
for (url in URLs) {
  repository_metadata_request <- GET(url)
  repository_metadata_XML <-read_xml(repository_metadata_request) 
  results_list <- extract_info(repository_metadata_XML) 
  repository_info <- rbind(repository_info, results_list)
}
```

**Result**

Here is a short view of the table of repositories which allow update data and provid DOI for discipline medicine. 

```{r}
head(repository_info)
```

